<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <link rel="apple-touch-icon" sizes="76x76" href="assets/img/apple-icon.png">
    <link rel="icon" type="image/png" href="assets/img/favicon-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="assets/img/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="assets/img/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="assets/img/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="assets/img/favicon-16x16.png" sizes="16x16">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title> Tablero de comandos </title>
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no'
        name='viewport' />

    <link rel="stylesheet" type="text/css" href="assets/css/fonts.css" />
    <link rel="stylesheet" type="text/css" href="assets/css/font-awesome.min.css">
    <link href="assets/css/material-dashboard.css?v=2.1.0" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">




    <meta charset="utf-8" />
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no'
        name='viewport' />
    <style type="text/css">
        .card {
            border: 2px;
            margin-bottom: 30px;
            margin-top: 30px;
            border-radius: 16px;



            color: rgba(0, 0, 0, 0.87);
            background: #ffffff;
            width: 100%;
            box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 3px 1px -2px rgba(0, 0, 0, 0.2), 0 1px 5px 0 rgba(0, 0, 0, 0.12);


            position: relative;
            display: flex;
            flex-direction: column;
            min-width: 0;
            word-wrap: break-word;

            font-size: .875rem;

        }
    </style>
</head>

<body class="dark-edition">

    <span id="muestraError" style="color: red; position: absolute;left: 50px;top:20px;"></span>
    <audio id="alerta1">
        <source src="./assets/mp3/alerta1.mp3" muted="muted" type="audio/mpeg" />
    </audio>
    <audio id="alerta2">
        <source src="./assets/mp3/alerta2.mp3" muted="muted" type="audio/mpeg" />
    </audio>
    <audio id="alerta3">
        <source src="./assets/mp3/alerta3.mp3" muted="muted" type="audio/mpeg" />
    </audio>
    <div class="section section-tabs" style="padding-top: 0px;">
        <div class="container" id="cuadradosHabitaciones">
        </div>
        <div class="container" id="alertamaxima" style="display:none;">
        </div>
    </div>
    <div class="modal fade" id="modalapagaalerta" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">¿Desea apagar la alerta de la habitación <span id="modalhab2"></span>? </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <i class="material-icons">clear</i>
                    </button>
                </div>
                <div class="modal-body">
                    <p>
                    <div class="form-check">
                        <label class="form-check-label">
                            <input class="form-check-input" type="radio" name="opcioncierre" value="tarjremota" checked>
                            Cerrar con tarjeta en los prox 30 segundos
                            <span class="circle">
                                <span class="check"></span>
                            </span>
                        </label>
                    </div>
                    <div class="form-check">
                        <label class="form-check-label">
                            <input class="form-check-input" type="radio" name="opcioncierre" value="cobid1">
                            covid atención por celular
                            <span class="circle">
                                <span class="check"></span>
                            </span>
                        </label>
                    </div>

                    </script>
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" data-dismiss="modal" class="btn btn-default">No</button>
                    <button type="button" class="btn btn-primary" id="modalapagardesdeapp"
                        style="margin-right: 20px; margin-left: 20px">apagar hab <span id="modalhab"></span></button>
                </div>
            </div>
        </div>
    </div>
    <!--   Core JS Files   -->
    <script src="assets/js/jquery.min.js" type="text/javascript"></script>
    <script src="assets/js/popper.min.js" type="text/javascript"></script>
    <script src="assets/js/bootstrap-material-design.min.js" type="text/javascript"></script>
    <script src="assets/js/perfect-scrollbar.jquery.min.js"></script>
    <script src="assets/js/material-dashboard.min.js"></script>
    <script>
        var cantAlertaMaxima = 0;
        var arrHabAlertaMaxima = [];
        var arrCamaAlertaMaxima = [];

        function disparaAlertaMaxima() {


        }


        var cuadrados = '<div class="row">';
        for (var h = 1; h <= 40; h++) {
            cuadrados = cuadrados + '<div class="col-12 col-sm-6 col-md-4 col-lg-3 col-xl-2 ">'
            cuadrados = cuadrados + ' <div class="p-3  card text-center cuadro d-none d-sm-block" id="Hcolor' + h + '">'
            cuadrados = cuadrados + '  <h1>' + h + '</h1>'
            cuadrados = cuadrados + '  <p style="margin-bottom: 0px;" id="Htexto' + h + '">&nbsp;</p>'
            cuadrados = cuadrados + '  <h6 style="margin-bottom: 0px;text-align: right !important;padding-right: 20px;" id="Hantiguedad' + h + '">&nbsp;</h6>'
            cuadrados = cuadrados + ' </div>'
            cuadrados = cuadrados + '</div>'
            // if (h % 6 == 0) { cuadrados = cuadrados + '</div><div class="row">' }
        }



        cuadrados = cuadrados + '</div>'

        $("#cuadradosHabitaciones").html(cuadrados).promise().done(function () {
            $(".cuadro").on('click', function (event) {
                event.stopPropagation();
                event.stopImmediatePropagation();
                let cual = this.id;

                client.publish('placa/' + cual.replace('Hcolor', ''), '9', { qos: 0, retained: false })


            });
        });

        $("#modalapagardesdeapp").attr('onClick', 'apagardesdeapp($(this))');

        function apagardesdeapp(c) {
            $("#modalapagardesdeapp").attr('onClick', '');
            var como = $('input[name=opcioncierre]:checked').val();
            var usuario = localStorage.getItem("usuario");
            if (usuario == undefined || usuario.length < 1) { usuario = "desconocido" }
            var hab = c.children("span").text()
            //console.log(como);
            //console.log(c.children("span").text());
            $.ajax({
                type: "POST",
                data: {
                    hab: hab,
                    quien: usuario,
                    como: como
                },
                contentType: 'application/x-www-form-urlencoded',
                mimeType: 'application/x-www-form-urlencoded', //Property added in 1.5.1
                url: "http://xyzopqwebserver:xyzopqwebport/apagardesdeapp",
                success: function (msg) {
                    $('#modalapagaalerta').modal('hide');
                    $("#modalapagardesdeapp").attr('onClick', 'apagardesdeapp($(this))');
                    setTimeout(chequeaStatus, 200);
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    $("#muestraError").html("no conecta con la base de datos ");
                    $("#modalapagardesdeapp").attr('onClick', 'apagardesdeapp($(this))');
                }
            });

        }


        function chequeaStatus() {


        }


    </script>

    <script>
        var ultrespuesta1 = Date.now();
        var heladera = "white";
        var puerta = 'cerrada';

        let servidor = 'http://192.168.1.36:3000';









    </script>

    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script>

        const options = {
            clean: true, // retain session
            connectTimeout: 4000,
            clientId: "tablero",
            username: "superuser",
            password: "superuser",
            keepalive: 0,
            qos: 0,

            keepalive: 60,
            will: {
                topic: 'WillMsg',
                payload: 'Connection Closed abnormally.. que loco!',
                qos: 0,
                retain: false
            },

            clean: true,
            rejectUnauthorized: false
        };
        //username: "UsuarioSOS",
        //password: "SOS2020",    

        const WebSocket_URL = "ws://icuadrado.net:8083/mqtt"
        const client = mqtt.connect(WebSocket_URL, options)

        client.on('error', function (err) {
            console.log(err)
            //client.end()
        })
        client.on('connect', function () {
            console.log('client connected:')
        })
        client.on('message', function (topic, message, pakcet) {
            console.log('Received Message:= ' + message.toString() + '\nOn topic:= ' + topic)
            var parte = topic.split("/");
            var accion = message.toString();
            if (parte[0] == 'placa') {






                var d = Date.now();
                var d2 = ultrespuesta1;

                $("#Hcolor" + parte[1]).css('color', 'black');
                if (accion == 1) {
                    $("#Hantiguedad" + parte[1]).html('mensaje');
                    $("#Hcolor" + parte[1]).css('background-color', '#DD0000')
                }
                if (accion == 0) {
                    $("#Hantiguedad" + parte[1]).html('&nbsp;');
                    $("#Hcolor" + parte[1]).css('background-color', '#00dd00')


                }

                $("#Hcolor" + parte[1]).css('color', 'white');
                $("#Htexto" + parte[1]).html('&nbsp;');

                if (cantAlertaMaxima > 0) {
                    disparaAlertaMaxima();

                    if (cantAlertaMaxima == 1) { $("#alerta1").trigger("play"); }
                    if (cantAlertaMaxima == 2) { $("#alerta2").trigger("play"); }
                    if (cantAlertaMaxima > 2) { $("#alerta3").trigger("play"); }

                } else { $("#cuadradosHabitaciones").css("display", "block"); }










            }

        })
        client.on('close', function () {
            console.log(' disconnected')
        })
        client.subscribe('placa/+', { qos: 0 });



    </script>
</body>

</html>