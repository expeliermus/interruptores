<html>

<head>
    <meta charset="utf-8">
    <link rel="apple-touch-icon" sizes="76x76" href="assets/img/apple-icon.png">
    <link rel="icon" type="image/png" href="assets/img/favicon-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="assets/img/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="assets/img/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="assets/img/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="assets/img/favicon-16x16.png" sizes="16x16">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="cache-control" content="max-age=864000" />
    <title>xyzopqdatodetitulo</title>
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
        integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script>
        window.jQuery || document.write('<script src="/path/to/your/jquery"><\/script>');
    </script>
    <style>
        .centrar {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 30px;
        }
    </style>


</head>

<body>

    <div>
        <section class="py-2">
            <div class="container text-center centrar">

                <div class="jumbotron shadow " style="background-color: lightcyan;">

                    <h2>xyzopqdatodetitulo</h2>
                    <h3 id="subtitulo"></h3>
                    <div class="row">
                        <div class=" my-3 mx-auto w-75" style="margin-bottom: 10px;">
                            <div class="shadow-lg border rounded p-4 h-100" style="background-color: white;">
                                <div class="row " id="botoneraweb">
                                    <div class="col-12">
                                        <p>Para llamar a enfermería puede usar los botones ubicados en cada cama o
                                            hacerlo desde su celular</p>
                                        <button class="btn  btn-success btn-round" type="button" id="eligetoken">desde
                                            celular</button>
                                    </div>
                                </div>
                                <div class="row" id="cambiarcama" style="display:none;">
                                    <div class="col-12">
                                        <p>Ud ya ulilizaba esta aplicación para una cama, pero ahora leyó el codigo QR de otra diferente
                                        </p>
                                        <button class="btn  btn-primary btn-round" id="btncambiarcama"
                                            type="button">Cambiar de cama</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>



                    <div class="float-right mt-4">Solo puede haber una botonera remota para cada cama</div>


                </div>
            </div>
        </section>
    </div>


    <script type="text/javascript">
        var cod = localStorage.getItem("cod");
        var token = localStorage.getItem("token");
        var flagcambiocama = false;
        var codurl = getUrlVars()["q"];
        if (codurl != 'undefined' && codurl != null) {
            //alert(codurl);
            // URL con codigo, verificarlo
            if (codurl.substring(0, 1) == 'P' && codurl.substring(3, 4) == 'H' && codurl.substring(6, 7) == 'C') {
                //P01H01C1
                if (cod != 'undefined' && cod != null) {
                    //existe un codigo de una oportunidad anterior
                    if (cod == codurl) {
                        if (token != 'undefined' && token != null) {
                            segundapantalla();
                        } else {
                            primerpantalla();
                        }
                    } else {
                        flagcambiocama = true;
                        primerpantalla();
                    }
                } else {
                    //situacion normal para la primer coneccion de todas
                    localStorage.setItem("cod", codurl);
                    var aux = window.location.href.slice(0, window.location.href.indexOf('?'))
                    window.location.href = aux;
                }
            } else {
                //como el codigo es invalido continuar como si no lo hubiera
                primerpantalla();
            }

        } else {
            //sin url
            if (cod != 'undefined' && cod != null && token != 'undefined' && token != null) {

                segundapantalla();

            } else {
                primerpantalla();
            }

        }


        function primerpantalla() {
            var subtitulo;
            if (cod != 'undefined' && cod != null) {
                if (cod.substring(0, 1) == 'P' && cod.substring(3, 4) == 'H' && cod.substring(6, 7) == 'C') {
                    piso = cod.substring(1, 3);
                    //hab = parseInt(cod.substring(4, 6));
                    hab = cod.substring(4, 6);
                    cama = cod.substring(7, 8);
                    subtitulo = "<h4>Habitacion: " + hab + ", cama: " + cama + "</h4>";

                    var eligetoken = "usar celular"
                    $("#eligetoken").html(eligetoken).attr('onClick', 'conseguirtoken()');
                    if (flagcambiocama) {
                        hab = codurl.substring(4, 6);
                        cama = codurl.substring(7, 8);
                        subtitulo = "<h4>Habitacion: " + hab + ", cama: " + cama + "</h4>";
                        $("#cambiarcama").css("display", "inline");
                        $("#botoneraweb").css("display", "none");
                        $("#btncambiarcama").attr('onClick', 'cambiardecama()');
                    }
                } else {
                    $("#botoneraweb").css("display", "none");
                    subtitulo = "<h4>Con cualquier aplicación, lea el codigo QR que corresponde a su cama</h4>";
                }
            } else {
                $("#botoneraweb").css("display", "none");
                subtitulo = "<h4>Con cualquier aplicación, lea el codigo QR que corresponde a su cama</h4>";
            }
            $("#subtitulo").html(subtitulo);
        }

        function cambiardecama() {
            localStorage.setItem("cod", codurl);
            localStorage.removeItem("token");
            var aux = window.location.href.slice(0, window.location.href.indexOf('?'))
            window.location.href = aux;

        }

        function borraregistro() {
            localStorage.removeItem("token");
            localStorage.removeItem("cod");
        }

        function segundapantalla() {
            var donde = window.location.href;
            donde = donde.replace('/remoto.', '/botonremoto.');
            console.log(donde);
            window.location.href = donde;
        }

        function conseguirtoken() {
             $.ajax({
                type: "POST",
                data: {
                    cod: cod,
                    topico: 'alta'
                },
                url: "http://xyzopqwebserver:xyzopqwebport/remotowebtoken",
                contentType: 'application/x-www-form-urlencoded',
                mimeType: 'application/x-www-form-urlencoded',
                success: function (msg) {
                    var respuesta = JSON.parse(msg);
                    if (respuesta[0].error == true) {
                        alert("No pudo conectarse al wifi del hospital");
                    } else {
                        token = respuesta[0].token;
                        localStorage.setItem("token", token);
                        segundapantalla();
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    $("#muestraError").html("no está conectado a la base de datos");
                }
            });
        }


        function getUrlVars() {
            var vars = [],
                hash;
            var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
            for (var i = 0; i < hashes.length; i++) {
                hash = hashes[i].split('=');
                vars.push(hash[0]);
                vars[hash[0]] = hash[1];
            }
            return vars;
        }

        function replaceAll(string, search, replace) {
            return string.split(search).join(replace);
        }
    
    </script>
</body>

</html>