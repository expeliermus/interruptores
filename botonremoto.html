<!DOCTYPE html>
<html lang="en">

<head>
    <title>Alerta remota</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="apple-touch-icon" sizes="76x76" href="assets/img/apple-icon.png">
    <link rel="icon" type="image/png" href="assets/img/favicon-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="assets/img/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="assets/img/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="assets/img/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="assets/img/favicon-16x16.png" sizes="16x16">
    <title> Hospital Universitario </title>
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
        integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <style>
        .btnalerta {
            width: 40%;
            
            margin-top: 5%;
        }
        .centrar {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 30px;
        }
    </style>

</head>

<body>


    <div>
        <section class="py-2">
            <div class="container text-center centrar">

                <div class="jumbotron shadow ">
                    <h2>Hospital Universitario</h2>
                  
                    <div class="row">
                        <div class="col-md-4 col-lg-12"><img class="btnalerta" src="assets/img/b1.png" alt="alerta 1" id="boton1">
                        </div>
                        <div class="col-md-4 col-lg-12"><img class="btnalerta" src="assets/img/b2.png" alt="alerta 2" id="boton2">
                        </div>
                        <div class="col-md-4 col-lg-12"><img class="btnalerta" id="resultado" style="visibility:hidden;"></div>
                    </div>
                    </div>
                </div>
            </div>
        </section>
    </div>









    <script type="text/javascript">

        var images = [];
        function preload() {
            for (var i = 0; i < arguments.length; i++) {
                images[i] = new Image();
                images[i].src = preload.arguments[i];
            }
        }
        preload(
            "assets/img/alerta1.png",
            "assets/img/alerta2.png",
            "assets/img/alerta3.png",
            "assets/img/alerta4.png",
            "assets/img/alerta5.png"
        )



        var token = localStorage.getItem("token");
        var cod = localStorage.getItem("cod");
        if (typeof token == 'undefined' || token == null || typeof cod == 'undefined' || cod == null) {
            //console.log("volver a la primer pantalla");
            primerpantalla();

        } else {
            //P01H01C1
            if (cod.substring(0, 1) == 'P' && cod.substring(3, 4) == 'H' && cod.substring(6, 7) == 'C') {
                segundapantalla();
            } else {
                primerpantalla();
            }
        }



        function primerpantalla() {
            var donde = window.location.href;
            donde = donde.replace('/botonremoto.', '/remoto.');
            //console.log(donde);
            window.location.href = donde;
        }

        function borraregistroYPrimerPantalla() {
            localStorage.removeItem("token");
            localStorage.removeItem("cod");
            setTimeout(function () {
                primerpantalla();
            }, 200);
        }

        function segundapantalla() {
            habilitabotones();
        }

        function habilitabotones() {
            //parece queera para evitar las tocadas iniciales por error
            //setTimeout(function () {
            $("#boton1").attr('onClick', 'enviaalerta(2)');
            $("#boton2").attr('onClick', 'enviaalerta(3)');
            //}, 1000);


        }


        function colorPasaAAlerta(a) {


        }

        function enviaalerta(a) {
            $("#boton1").attr('onClick', '');
            $("#boton2").attr('onClick', '');


            //console.log(token);

            $.ajax({
                type: "POST",
                data: {
                    cod: cod,
                    topico: 'alerta',
                    alerta: a,
                    tokenactual: token
                },
                contentType: 'application/x-www-form-urlencoded',
                mimeType: 'application/x-www-form-urlencoded',
                url: "http://xyzopqwebserver:xyzopqwebport/remotowebtoken",
                success: function (msg) {
                    var respuesta = JSON.parse(msg);
                    //console.log(msg);
                    //console.log(respuesta[0].error);
                    if (respuesta[0].error == true) {
                        alert("hay un error en la aplicacion: no se envió el topico o código");
                    } else {
                        if (respuesta[0].token == 'equivocado') {
                            alert('Solamente puede haber una botonera remota por cada cama, la suya no es la mas reciente');
                            borraregistroYPrimerPantalla();

                        } else {
                            var color = respuesta[0].color;
                            if (color == '2') {
                                //colorPasaAAlerta(color);
                            }
                            if (color >= '1' && color <= '5') {
                                var imagen = 'assets/img/alerta' + color + '.png';
                                $("#resultado").attr('src', imagen).css("visibility", "visible");
                                setTimeout(function () {
                                    $("#resultado").attr('src', 'assets/img/alerta1.png').css("visibility", "hidden");
                                }, 10000);
                            }

                        }
                    }

                    habilitabotones();
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    $("#muestraError").html("no está conectado a la base de datos");
                    habilitabotones();
                }
            });

        }


    </script>
</body>

</html>