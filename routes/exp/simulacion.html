<!DOCTYPE html>
<html lang="en">

<head>
    <title>Boton test</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="apple-touch-icon" sizes="76x76" href="assets/img/apple-icon.png">
    <link rel="icon" type="image/png" href="assets/img/favicon-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="assets/img/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="assets/img/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="assets/img/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="assets/img/favicon-16x16.png" sizes="16x16">
    <title> MQTT </title>
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
        integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <style>

    </style>

</head>

<body>


    <div>
        
        


        <section class="py-2">
            <div class="container text-center centrar">
                <div class="jumbotron shadow ">
                    <h2>simulacion</h2>
                    <div class="row">
                        <label for="mac">nueva mac
                            <input id="mac" type="text" value="mac"/>
                        </label>
                        <button id="btnclientid" >Alta</button>
                    </div>
                    <h3>operando sobre mac: <span id="operandosobretexto"></span></h3>
                    <div class="row">
                        <label for="operarsobre">cambiar mac 
                            <input id="operarsobre" type="text" />
                        </label>
                        <button id="btnoperarsobre" >click</button>
                    </div>
                    <div class="row">
                        <label for="rfid">cual rfid?
                            <input id="rfid" type="text" />
                        </label>
                        <button id="btnrfid" >rfid</button>
                    </div>
                    <div class="row">
                        <label for="alerta">cual alerta?
                            <input id="alerta" type="text" />
                        </label>
                        <button id="btnalerta" >alerta</button>
                    </div>
                    <div class="row">
                        <h5>mas reciente estado de todos los topicos</h5>
                        <div id="estado"></div>
                        <div id="estadocolor" style="height: 150px; width: 150px; "></div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script>
        var clientId = 'webSocket_' + Math.random().toString(16).substr(2, 8)
        const options = {
            clean: true, // retain session
            connectTimeout: 4000,
            clientId: clientId,
            keepalive: 60,
            will: {
                topic: 'WillMsg',
                payload: 'Connection Closed abnormally.. que loco!',
                qos: 0,
                retain: false
            },

            clean: true,
            rejectUnauthorized: false
        };
        //username: "UsuarioSOS",
        //password: "SOS2020",    

        const WebSocket_URL = "ws://icuadrado.net:8083/mqtt"
        const client = mqtt.connect(WebSocket_URL, options)

        client.on('error', function (err) {
            console.log(err)
            client.end()
        })

        client.on('connect', function () {
            console.log('client connected:' + clientId)
        })

       

        client.on('message', function (topic, message, pakcet) {
            console.log('Received Message:= ' + message.toString() + '\nOn topic:= ' + topic)
            var parte = topic.split("/");
            var accion = message.toString().split(";");
            if (parte[1] == 'estado'){
                document.getElementById('estado').innerHTML= accion ;
                let R = parseInt(accion[0]/4);
                let G = parseInt(accion[1]/4);
                let B = parseInt(accion[2]/4);
                $('#estadocolor').css('background-color','rgb('+R+','+G+','+B+')');
            }

        })

        client.on('close', function () {
            console.log(clientId + ' disconnected')
        })

        client.subscribe('+/estado', { qos: 0 });
        
        
        
    </script>
<script>
    $("#btnclientid").attr('onClick', 'mqttalta()');
    $("#btnoperarsobre").attr('onClick', 'cambiarfoco()');
    $("#btnrfid").attr('onClick', 'rfid()');
    $("#btnalerta").attr('onClick', 'alerta()');
    document.getElementById('operandosobretexto').innerHTML =  localStorage.getItem("simulacion");
    
    function cambiarfoco() {
        let val=$('#operarsobre').val();
        localStorage.setItem("simulacion",val);
        console.log(val);
        document.getElementById('operandosobretexto').innerHTML = val;
    };

    function mqttalta(){
        let mac=$("#mac").val();
        localStorage.setItem("simulacion",mac);
        //client.subscribe('alta/', { qos: 0 })
        client.publish('alta/', mac, { qos: 0, retained: false })
        console.log ('alta/', mac, { qos: 0, retained: false });
        document.getElementById('operandosobre').innerHTML= mac ;
    }

    function rfid(){
        let mac=$("#operandosobretexto").text();
        let rfid=$("#rfid").val();
        client.publish(mac+'/rfid', rfid, { qos: 0, retained: false });
        console.log (mac+'/rfid', rfid, { qos: 0, retained: false });
    }

    function alerta(){
        let mac=$("#operandosobretexto").text();
        let alerta=$("#alerta").val();
        client.publish(mac+'/alerta', alerta, { qos: 0, retained: false });
        console.log(mac+'/alerta', alerta, { qos: 0, retained: false });
    }
</script>

</body>

</html>